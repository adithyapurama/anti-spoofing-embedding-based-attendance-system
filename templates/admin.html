<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    input, button { padding: 10px; margin: 8px; font-size: 16px; }
    #videoWrap { position: relative; display: inline-block; width: 100%; max-width: 480px; }
    video, canvas {
      width: 100%;
      height: auto;
      border-radius: 8px;
      border: 1px solid #333;
    }
    canvas { position: absolute; left: 0; top: 0; pointer-events: none; }
    #video { transform: scaleX(-1); }     /* flip back to normal view */
    canvas { position: absolute; left: 0; top: 0; pointer-events: none; }
    #status { font-weight: bold; margin-top: 12px; }
    ul { list-style-type: none; padding: 0; margin-top: 10px; }
    li { background: #f1f1f1; margin: 3px 0; padding: 8px; border-radius: 4px; }
    #progress { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>

  <h3>Add / Update User</h3>
  <input type="text" id="userId" placeholder="Enter User ID">
  <input type="password" id="password" placeholder="Enter Password">
  <button id="enrollBtn" onclick="enrollUser()" disabled>Add / Update User</button>
  <button id="startCam">Start Camera</button>
  <button id="stopCam" disabled>Stop Camera</button>
  <br><br>


  <p id="status">Idle</p>
  <p id="progress"></p>

  <div id="videoWrap">
    <video id="video" autoplay playsinline></video>
    <canvas id="overlay"></canvas>
  </div>

  <h3>Registered Users:</h3>
  <ul id="enrolledUsers"></ul>

  <script>
  const video = document.getElementById("video");
  const overlay = document.getElementById("overlay");
  const ctx = overlay.getContext("2d");
  let stream = null;
  let polling = false;

  startCam.onclick = startCamera;
  stopCam.onclick = stopCamera;

  async function startCamera() {
    if (stream) stopCamera();

    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
    video.srcObject = stream;
    await video.play();

    overlay.width = video.videoWidth || video.clientWidth;
    overlay.height = video.videoHeight || video.clientHeight;

    polling = true;
    pollLoop();

    startCam.disabled = true;
    stopCam.disabled = false;
    document.getElementById("status").innerText = "Camera started";
  }

  function stopCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = null;
    polling = false;

    startCam.disabled = false;
    stopCam.disabled = true;
    enrollBtn.disabled = true;

    ctx.clearRect(0, 0, overlay.width, overlay.height);
  }

  function capturePollFrame() {
  const temp = document.createElement("canvas");
  temp.width = overlay.width;
  temp.height = overlay.height;
  const tctx = temp.getContext("2d");

  tctx.save();
  tctx.scale(-1, 1);                 // mirror frame BEFORE sending
  tctx.translate(-temp.width, 0);
  tctx.drawImage(video, 0, 0, temp.width, temp.height);
  tctx.restore();

  return temp.toDataURL("image/jpeg", 0.4);
}


  async function pollLoop() {
    while (polling) {
      try {
        const frame = capturePollFrame();
        const res = await fetch("/process_frame", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ frame: frame, user_id: "REGISTRATION" })
        });

        const j = await res.json();
        drawLiveResult(j);

        // enable button only on REAL face
        enrollBtn.disabled = !(j.spoof === "real");

      } catch (e) {
        enrollBtn.disabled = true;
      }

      await new Promise(res => setTimeout(res, 450));
    }
  }

  function drawLiveResult(j) {
  ctx.clearRect(0, 0, overlay.width, overlay.height);
  if (!j || !j.bbox) return;

  const [x, y, w, h] = j.bbox;
  const [r, g, b] = j.color || [255,255,0];

  ctx.save();
  ctx.scale(-1, 1);
  ctx.translate(-overlay.width, 0);

  // MIRRORED X COORDINATE
  const mx = overlay.width - x - w;

  ctx.lineWidth = 3;
  ctx.strokeStyle = `rgb(${r},${g},${b})`;
  ctx.strokeRect(mx, y, w, h);

  const txt = j.spoof === "real"
      ? "‚úÖ Real face detected"
      : "‚ùå Spoof detected";

  ctx.font = "18px Arial";
  ctx.fillStyle = "#fff";
  ctx.fillText(txt, mx + 4, y - 6);

  ctx.restore();
}


  // Capture a frame as base64 JPEG
  function captureFrame() {
    ctx.drawImage(video, 0, 0, overlay.width, overlay.height);
    return overlay.toDataURL("image/jpeg");
  }

  async function enrollUser() {
    const userId = document.getElementById("userId").value.trim();
    const password = document.getElementById("password").value.trim();
    if (!userId || !password) {
      alert("Enter User ID and Password!");
      return;
    }

    document.getElementById("status").innerText = "üì∏ Capturing images...";
    document.getElementById("progress").innerText = "";

    const images = [];
    const NUM_CAPTURES = 7; // how many frames to capture
    const CAPTURE_INTERVAL = 800; // ms between captures

    for (let i = 0; i < NUM_CAPTURES; i++) {
      images.push(captureFrame());
      document.getElementById("progress").innerText = `Captured ${i+1}/${NUM_CAPTURES}`;
      await new Promise(res => setTimeout(res, CAPTURE_INTERVAL));
    }

    document.getElementById("status").innerText = "‚è≥ Sending to server...";

    const res = await fetch("/admin_add_user", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({user_id: userId, password: password, images: images})
    });

    const result = await res.json();

    if (result.status === "ok") {
      document.getElementById("status").innerText =
        `‚úÖ User '${result.user_id}' enrolled with ${result.emb_count} images (quality: ${result.reg_quality.toFixed(1)})`;
      document.getElementById("progress").innerText = "";
      loadUsers();
    } else {
      document.getElementById("status").innerText =
        `‚ùå Error: ${result.message || result.status}`;
    }
  }

  async function loadUsers() {
    const response = await fetch("/list_users");
    const data = await response.json();
    const userList = document.getElementById("enrolledUsers");
    userList.innerHTML = "";
    data.users.forEach(user => {
      const li = document.createElement("li");
      li.innerText = user;
      userList.appendChild(li);
    });
  }

  window.onload = loadUsers;
  </script>
</body>
</html>
